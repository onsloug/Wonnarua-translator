name: Python CI/CD

on:
  pull_request:
    types: [opened, synchronize, reopened]
  push:
    branches:
      - Dev
      - Uat
      - Prod
  workflow_call:

jobs:
  lint:
    name: Lint and Code Format Check
    runs-on: ubuntu-latest

    steps:
      - name: "â˜ï¸ Checkout repository"
        uses: actions/checkout@v4

      - name: "ğŸ Set up Python"
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: "ğŸ“¦ Install linting tools"
        run: |
          python -m pip install --upgrade pip
          pip install ruff black

      - name: "ğŸ” Lint with Ruff"
        run: ruff check .

      - name: "ğŸ§¹ Check code formatting with Black"
        run: black --check .

  test:
    name: Run Unit Tests
    runs-on: ubuntu-latest
    needs: lint
    strategy:
      matrix:
        environment: [dev, uat, prod]

    steps:
      - name: "â˜ï¸ Checkout repository"
        uses: actions/checkout@v4

      - name: "ğŸ Set up Python"
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: "ğŸ“¦ Install dependencies for ${{ matrix.environment }}"
        run: |
          python -m pip install --upgrade pip
          if [ -f "requirements-${{ matrix.environment }}.txt" ]; then
            pip install -r requirements-${{ matrix.environment }}.txt
          else
            echo "âš ï¸ requirements-${{ matrix.environment }}.txt not found, using default requirements.txt"
            pip install -r requirements.txt
          fi
          pip install pytest pytest-cov

      - name: "âœ… Verify dependency integrity"
        run: pip check

      - name: "ğŸ§ª Run tests"
        run: pytest src/test --maxfail=1 --disable-warnings -q --cov=src

  deploy:
    name: Deploy to environment
    runs-on: ubuntu-latest
    needs: [test]
    if: github.ref == 'refs/heads/dev' || github.ref == 'refs/heads/uat' || github.ref == 'refs/heads/main'

    environment:
      name: ${{ github.ref_name }}  # Connects to GitHub Environment (dev/uat/prod)
      url: ${{ steps.deploy.outputs.deploy_url || '' }}

    steps:
      - name: "â˜ï¸ Checkout repository"
        uses: actions/checkout@v4

      - name: "ğŸ Set up Python"
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: "ğŸš€ Deploy to environment"
        env:
          ENV_NAME: ${{ github.ref_name }}
          SECRET_API_KEY: ${{ secrets.DEPLOY_API_KEY }}  # Example of env secret
        run: |
          echo "Starting deployment to $ENV_NAME environment..."

          case "$ENV_NAME" in
            dev)
              echo "Deploying to Development..."
              # Add dev deployment logic here
              ;;
            uat)
              echo "Deploying to UAT..."
              # Add UAT deployment logic here
              ;;
            main)
              echo "Deploying to Production..."
              # Add prod deployment logic here
              ;;
          esac

          echo "âœ… Deployment to $ENV_NAME complete!"
